<!DOCTYPE html>
<html lang="en">
<head>
	<script src="/socket.io/socket.io.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script type="text/babel" >
        "use strict";
		let ctx;
		let socket;
		let id;
		let draws = {};
        let users = {};
		
		const draw = () => {
			ctx.fillStyle="grey";
			ctx.fillRect(0, 0, canvas.width, canvas.height);
			let keys = Object.keys(draws);
			
			for(let i = 0; i < keys.length; i++){
				const drawCall = draws[keys[i]];
				ctx.fillStyle = drawCall.color;
                ctx.beginPath();
                ctx.arc(drawCall.x,drawCall.y,drawCall.rad,0,2*Math.PI);
                ctx.fill();
				//ctx.fillRect(drawCall.x, drawCall.y, drawCall.width, drawCall.height);
			}
			console.log(draws);
		};
        
        const displayUsers = () => {
            const userList = document.querySelector("#userList");
            // clear box
            userList.innerHTML = "";
            
			let keys = Object.keys(users);
			for(let i = 0; i < keys.length; i++){
                let user = document.createElement("LI");
                user.style.color = users[i].color;
                user.innerHTML += (users[i].name + " - " + users[i].points + " points");
                userList.appendChild(user);
            }
        };
		
        const start = (e) => {
            console.log('start');
            socket.emit('start');
        };
        
		const sendClick = (e) => {
            console.log('click');
			let clickDat = {};
			clickDat.id = id;
			clickDat.x = e.pageX;
			clickDat.y = e.pageY;
			socket.emit('click', clickDat);
		};
		
		const init = () => {
			const canvas = document.querySelector("#canvas");
			ctx = canvas.getContext('2d');
			
			socket = io.connect();
			
			socket.on('connect', () => {
				console.log('connecting');
				socket.emit('join', {});
			});
			
			socket.on('syncClient', (data) => {
				id = data.id;
				draws = data.Circles;
                users = data.Users;
				draw();
				console.log('synced');
			});
			
			socket.on('updateUsers', (data) => {
				users[data.user.id] = data.user;
                displayUsers();
			});
            
            socket.on('updateCircles', (data) => {
                draws[data.circle.num] = data.circle;
				draw();
            });
            
            socket.on('reset', (data) => {
				draws = data.Circles;
                users = data.Users;
				draw();
                displayUsers();
            });
			
			canvas.onmousedown = sendClick;
            
            const startButton = document.querySelector("#startButton");
            startButton.addEventListener('click', start);
		};
		
		window.onload = init;
    </script>
    <style>
        body {
            margin: 0px;
            padding: 0px;
        }
        #userBox {
        }
        #userList { 
            list-style-type: none;
        }
    </style>
</head>
<body>
    
	<canvas id="canvas" width="640" height="480"></canvas>
	<input id="startButton" type="button" value="start" />
    <div id="userBox"><ul id="userList"></ul></div>
    
</body>
</html>